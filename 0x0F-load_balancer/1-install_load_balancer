#!/usr/bin/env bash
# Update the package lists
# Install load balancer

echo "Updating and doing some minor checks..."

# Check and install nginx if not installed
install_package() {
    local package_name=$1
    if ! command -v "$package_name" &>/dev/null; then
        echo "Installing: $package_name"
        sudo apt-get update -y -qq && sudo apt-get install -y "$package_name" -qq
        echo
    else
        echo "$package_name is already installed."
    fi
}

check_and_install nginx
install_package haproxy

echo "Setting up some minor stuff."

# Backup default server config file
sudo cp /etc/haproxy/haproxy.cfg haproxy_default.backup

# Configure haproxy
cat << EOF |sudo tee -a /etc/haproxy/haproxy.cfg
listen load_balancer
        bind :80
        mode http
        option httpclose
        option forwardfor
        balance roundrobin
        server 434428-web-01 35.153.16.18:80 check
        server 434428-web-02 54.89.135.5:80 check
EOF

echo "$server_config" | sudo dd status=none of=/etc/haproxy/haproxy.cfg

echo "ENABLED=1" | sudo dd status=none of=/etc/default/haproxy

echo "configured - Roundrobin On web-01 & web-02"

if ! pgrep -c haproxy &>/dev/null; then
    sudo service haproxy start
else
    sudo service haproxy restart
fi
